<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1 class="text-center mt-4">–ö–æ—Ä–∑–∏–Ω–∞</h1>

        <% if (items.length === 0) { %>
            <p class="text-center text-muted">üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
        <% } else { %>
            <div id="cart-items" class="row">
                <% items.forEach(item => { %>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <img src="/images/<%= item.image %>" class="card-img-top" alt="<%= item.name %>">
                            <div class="card-body text-center">
                                <h5 class="card-title"><%= item.name %></h5>
                                <p class="card-text"><strong><%= item.price.toLocaleString() %>‚Ç∏</strong></p>
                                <p>–ö–æ–ª-–≤–æ: <%= item.quantity %></p>
                                <button class="btn btn-danger btn-sm" onclick="removeFromCart('<%= item._id %>')">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>

            <h3 class="text-end mt-3">–ò—Ç–æ–≥–æ: <span id="total-price"><%= totalPrice.toLocaleString() %></span>‚Ç∏</h3>
            <div id="checkout-container"></div> <!-- JS –¥–æ–±–∞–≤–∏—Ç –∫–Ω–æ–ø–∫—É —Å—é–¥–∞ -->
        <% } %>
    </div>

    <script>
        async function loadCart() {
            try {
                const response = await fetch('/api/v1/cart', { headers: { 'Accept': 'application/json' } });

                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã");

                const data = await response.json();
                if (!data.success) return;

                let cartContainer = document.getElementById('cart-items');
                let totalPriceElement = document.getElementById('total-price');
                let checkoutContainer = document.getElementById('checkout-container'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç—å"

                cartContainer.innerHTML = "";
                checkoutContainer.innerHTML = ""; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º

                if (data.items.length === 0) {
                    cartContainer.innerHTML = `<p class="text-center">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>`;
                    totalPriceElement.textContent = "0";
                    return;
                }

                let total = 0;
                data.items.forEach(item => {
                    let cartItem = document.createElement('div');
                    cartItem.classList.add('col-md-4', 'mb-3');

                    cartItem.innerHTML = `
                        <div class="card">
                            <img src="/images/${item.image}" class="card-img-top" alt="${item.name}">
                            <div class="card-body text-center">
                                <h5 class="card-title">${item.name}</h5>
                                <p class="card-text"><strong>${item.price.toLocaleString()}‚Ç∏</strong></p>
                                <p>–ö–æ–ª-–≤–æ: ${item.quantity}</p>
                                <button class="btn btn-danger btn-sm" onclick="removeFromCart('${item._id}')">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;

                    cartContainer.appendChild(cartItem);
                    total += item.price * item.quantity;
                });

                totalPriceElement.textContent = total.toLocaleString();

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å", –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±–æ–ª—å—à–µ 0
                let checkoutButton = document.createElement('button');
                checkoutButton.classList.add('btn', 'btn-success', 'w-100', 'mt-3');
                checkoutButton.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å';
                checkoutButton.onclick = () => window.location.href = '/checkout';

                checkoutContainer.appendChild(checkoutButton);

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã:", error);
            }
        }

        async function removeFromCart(itemId) {
            try {
                const response = await fetch('/api/v1/cart/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId })
                });

                const data = await response.json();
                if (data.success) {
                    loadCart();
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: " + data.message);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:", error);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            }
        }

        loadCart();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
